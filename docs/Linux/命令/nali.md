## 显示IP来源的小工具  -- nali

### 简介

> 一个查询IP地理信息和CDN服务提供商的离线终端工具.
>
> 查询是在本地进行，并不会进行联网查询，所以效率方面不会有什么影响。

### 功能

> * 支持多种数据库
>   * 纯真 IPv4 离线数据库
>   * ZX IPv6 离线数据库
>   * Geoip2 城市数据库 (可选)
>   * IPIP 数据库 (可选)
>   * ip2region 数据库 (可选)
>   * DB-IP 数据库 (可选)
>   * IP2Location DB3 LITE 数据库 (可选)
> * CDN 服务提供商查询
> * 支持管道处理
> * 支持交互式查询
> * 同时支持IPv4和IPv6
> * 支持多语言
> * 查询完全离线
> * 全平台支持
> * 支持彩色输出

### 安装

#### 下载软件包

```
# 下载软件包
wget https://github.com/zu1k/nali/releases/download/v0.8.1/nali-linux-amd64-v0.8.1.gz
# 下载IP库
https://github.com/HMBSbige/qqwry/releases/download/2024-02-21/qqwry.dat
```

#### 解压并安装

```
gzip -d nali-linux-amd64-v0.8.1.gz
chmod +x nali-linux-amd64-v0.8.1
mv nali-linux-amd64-v0.8.1 /usr/local/bin/nali

# 将离线IP库放入指定目录
mkdir /root/.nali
mv qqwry.dat /root/.nali/
```

### 使用

#### 查询一个IP的地理信息

```
[root@1panenl ~]# nali 1.2.3.4
1.2.3.4 [澳大利亚 APNIC Debogon-prefix网络] 
```

#### 配合管道

```
[root@1panenl ~]# echo IP 6.6.6.6 | nali
IP 6.6.6.6 [美国亚利桑那州华楚卡堡市 美国国防部网络中心] 
```

#### 同时查询多个IP的地理信息

```
[root@1panenl ~]# nali 1.2.3.4 1.1.1.1 114.114.114.114
1.2.3.4 [澳大利亚 APNIC Debogon-prefix网络] 
1.1.1.1 [澳大利亚 APNIC/CloudFlare公共DNS服务器] 
114.114.114.114 [江苏省南京市 南京信风网络科技有限公司GreatbitDNS服务器] 
```

#### 交互式查询

> 使用 `exit` 或 `quit` 退出查询

```
[root@1panenl ~]# nali
1.1.1.1
1.1.1.1 [澳大利亚 APNIC/CloudFlare公共DNS服务器] 
2.2.2.2
2.2.2.2 [法国 Orange] 
8.8.8.8
8.8.8.8 [美国加利福尼亚州圣克拉拉县山景市 谷歌公司DNS服务器] 
quit
```

#### 与dig结合

```
[root@1panenl ~]# dig nali.zu1k.com +short | nali
104.28.2.115 [美国 CloudFlare公司CDN节点]
104.28.3.115 [美国 CloudFlare公司CDN节点]
172.67.135.48 [美国 CloudFlare节点]
```

#### 与mtr结合

```
[root@1panenl ~]# mtr www.baidu.com | nali
                                                                      My traceroute  [v0.85]
1panenl (0.0.0.0 [IANA 保留地址] )                                                                                                        Tue Mar 19 13:33:53 2024
Keys:  Help   Display mode   Restart statistics   Order of fields   quit
                                                                                                                          Packets               Pings
 Host                                                                                                                   Loss%   Snt   Last   Avg  Best  Wrst StDev
 1. 192.168.1.1 [局域网 对方和您在同一内部网]                                                                            0.0%     8    0.9   0.6   0.4   0.9   0.0
 2. 1.89.212.222.broad.cd.sc.dynamic.163data.com.cn                                                                      0.0%     8    6.1   4.0   2.0   7.0   1.7
 3. 171.223.204.113 [四川省成都市 电信]                                                                                 85.7%     8    4.2   4.2   4.2   4.2   0.0
 4. 171.208.199.225 [四川省遂宁市 电信]                                                                                 42.9%     8    3.7   3.5   3.2   3.7   0.0
 5. 202.97.29.45 [中国 电信骨干网]                                                                                      71.4%     8   32.4  32.2  31.9  32.4   0.0
 6. 113.96.4.74 [广东省广州市 电信/IDC机房]                                                                             28.6%     8   39.2  36.0  34.0  39.2   1.9
 7. 113.96.4.210 [广东省广州市 电信/IDC机房]                                                                            42.9%     7   32.6  32.4  31.9  33.1   0.0
 8. ???
 9. 14.29.117.178 [广东省广州市 电信]                                                                                    0.0%     7   38.3  38.7  34.3  47.0   4.3
10. ???
11. ???
12. ???
13. ???
14. 183.2.172.185 [广东省广州市 电信/IDC机房]                                                                            0.0%     7   58.2  41.0  37.5  58.2   7.6
```

> 探测你的网络到某个地址的跳转链路

### 实用场景

#### 分析nginx日志中访问来源IP

```
[root@VM-0-3-centos ~]# cat /www/wwwlogs/access.log  | awk '{print $1}'| nali|more
74.120.14.43 [美国] 
74.120.14.43 [美国] 
74.120.14.43 [美国] 
222.212.191.219 [四川省成都市 电信] 
222.212.191.219 [四川省成都市 电信] 
222.212.191.219 [四川省成都市 电信] 
222.212.191.219 [四川省成都市 电信] 
47.241.185.192 [新加坡 阿里云] 
47.241.185.192 [新加坡 阿里云] 
47.241.185.192 [新加坡 阿里云] 
161.189.134.11 [宁夏中卫 亚马逊云] 
161.189.192.94 [宁夏中卫 亚马逊云] 
161.189.134.11 [宁夏中卫 亚马逊云] 
161.189.134.11 [宁夏中卫 亚马逊云] 
183.136.225.14 [浙江省嘉兴市 电信] 
183.136.225.14 [浙江省嘉兴市 电信] 
183.136.225.14 [浙江省嘉兴市 电信] 
183.136.225.14 [浙江省嘉兴市 电信] 
170.130.187.18 [美国] 
193.106.29.74 [立陶宛] 
```

#### 统计nginx日志中访问次数前10的ip

```
[root@VM-0-3-centos ~]# awk '{sum[$1]++}END{for(ip in sum) print ip, sum[ip]}' /www/wwwlogs/access.log |sort -nr -k 2|head |nali
123.56.155.157 [北京市 阿里云BGP数据中心]  2105
8.219.71.118 [中国 阿里云]  1524
8.219.119.144 [中国 阿里云]  1404
47.101.154.149 [上海市 阿里云]  1383
47.101.149.21 [上海市 阿里云]  1082
91.194.84.88 [德国]  1007
8.134.89.107 [广东省深圳市 阿里云]  825
117.25.149.164 [福建省厦门市 电信/IDC机房]  788
123.57.235.51 [北京市 阿里云BGP数据中心]  751
173.225.110.122 [美国]  713
```

#### 统计/var/log/secure日志中，被爆破的次数，取前10个IP

```bash
# 方法1
[root@VM-0-3-centos ~]# grep 'Failed' /var/log/secure | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr | head -n 10 | while read count ip; do location=$(echo $ip | nali); printf "%s [%s] %s\n" "$ip" "$location" "$count"; done
206.189.145.40 [206.189.145.40 [新加坡 DigitalOcean数据中心] ] 37870
125.124.210.198 [125.124.210.198 [浙江省嘉兴市海宁市 电信] ] 15559
45.117.213.52 [45.117.213.52 [印度] ] 11975
119.42.115.163 [119.42.115.163 [泰国] ] 10663
93.123.39.242 [93.123.39.242 [保加利亚] ] 6603
116.169.63.135 [116.169.63.135 [四川省 联通] ] 6074
113.250.163.226 [113.250.163.226 [重庆市 电信] ] 6000
122.224.37.86 [122.224.37.86 [浙江省绍兴市 电信] ] 4252
167.172.106.245 [167.172.106.245 [英国] ] 3791
223.70.124.194 [223.70.124.194 [北京市 移动/中国移动北京分公司] ] 3559

# 方法2
[root@VM-0-3-centos ~]# grep 'Failed' /var/log/secure | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr | head -n 10 | nali
  37870 206.189.145.40 [新加坡 DigitalOcean数据中心] 
  15559 125.124.210.198 [浙江省嘉兴市海宁市 电信] 
  11975 45.117.213.52 [印度] 
  10663 119.42.115.163 [泰国] 
   6603 93.123.39.242 [保加利亚] 
   6074 116.169.63.135 [四川省 联通] 
   6000 113.250.163.226 [重庆市 电信] 
   4252 122.224.37.86 [浙江省绍兴市 电信] 
   3791 167.172.106.245 [英国] 
   3559 223.70.124.194 [北京市 移动/中国移动北京分公司] 
```

#### 获取登录成功的IP   -- 哭死，我的服务器被棒子给干了😭，血泪经验

```bash
# 方法1
[root@VM-0-3-centos ~]# grep 'Accepted' /var/log/secure | awk '{print $1, $2, $3, $(NF-3)}' | nali
Mar 17 00:34:10 211.234.111.116 [韩国] 
Mar 18 07:58:24 211.234.111.116 [韩国] 
Mar 18 18:27:17 211.234.111.116 [韩国] 
Mar 18 20:39:38 125.69.9.185 [四川省成都市锦江区 电信] 
Mar 18 20:42:37 125.69.9.185 [四川省成都市锦江区 电信] 
Mar 19 10:52:29 222.212.89.58 [四川省成都市 电信] 
Mar 19 13:36:41 222.212.89.58 [四川省成都市 电信] 
Mar 20 08:37:23 211.234.111.116 [韩国] 
Mar 21 08:15:08 211.234.111.116 [韩国] 
Mar 21 20:18:02 211.234.111.116 [韩国] 
Mar 22 08:46:16 211.234.111.116 [韩国] 
Mar 23 19:50:08 211.234.111.116 [韩国] 
Mar 24 21:26:06 211.234.111.116 [韩国] 
Mar 25 14:28:05 211.234.111.116 [韩国] 
Mar 25 20:16:19 211.234.111.116 [韩国] 
Mar 26 06:49:02 211.234.111.116 [韩国] 
Mar 27 19:25:55 211.234.111.116 [韩国] 
Mar 28 21:03:03 211.234.111.116 [韩国] 
Mar 29 14:41:13 211.234.111.116 [韩国] 
Mar 29 17:33:39 211.234.111.116 [韩国] 
Mar 31 13:52:53 211.234.111.116 [韩国] 
Apr 1 07:58:15 211.234.111.116 [韩国] 
Apr 1 14:37:04 211.234.111.116 [韩国] 
Apr 1 20:12:09 211.234.111.116 [韩国] 
Apr 6 08:58:22 211.234.111.116 [韩国] 
Apr 6 23:50:51 211.234.111.116 [韩国] 
Apr 10 07:17:00 211.234.111.116 [韩国] 
Apr 10 14:48:09 211.234.111.116 [韩国] 
Apr 11 06:12:36 211.234.111.116 [韩国] 

# 方法2
[root@VM-0-3-centos ~]# last | awk '{print $(NF-7),$4,$5,$6}' | nali
awk: cmd. line:1: (FILENAME=- FNR=297) fatal: attempt to access field -1
11.163.0.12 [美国俄亥俄州哥伦布市 DoD网络信息中心]  Sun Apr 7  20:02
reboot system boot 16:09
reboot system boot 16:09
125.69.9.185 [四川省成都市锦江区 电信]  Mon Mar 18  20:44
reboot system boot 15:37
125.69.9.185 [四川省成都市锦江区 电信]  Mon Mar 18  down
```
